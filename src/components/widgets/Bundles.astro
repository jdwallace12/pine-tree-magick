---
import { getCollection } from 'astro:content';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';

const {
  title,
  subtitle,
  tagline,
  id,
  isDark = false,
  classes = {},
  expirationDate,
  items,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Use passed items or fetch from collection with default empty array
let activeBundles = items || [];
if (!items) {
  const bundles = await getCollection('bundle');
  const currentDate = new Date();
  activeBundles = bundles.filter((bundle) => {
    if (!bundle.data.expirationDate) return true;
    const [month, day, year] = bundle.data.expirationDate.split('/');
    const expirationDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    return currentDate <= expirationDate;
  });
  // Note: We're not sorting here anymore as it's handled in getShopComponents
}

---
<WidgetWrapper id={id} isDark={isDark} containerClass={classes?.container} bg={bg}>
  <Headline 
    title={title} 
    subtitle={subtitle} 
    tagline={tagline} 
    classes={{
      container: 'sm:mx-0 lg:max-w-none text-left md:mb-8',
      title: 'text-left',
      subtitle: 'text-left'
    }}
  />
  {activeBundles.length > 0 ? (
    <div class="flex flex-col gap-6 lg:gap-8 mx-auto max-w-3xl px-0 w-full">
      {activeBundles.map((bundle) => (
        <a href={`/bundles/${bundle.id.replace(/\.md$/, '')}`} class="relative flex flex-row w-full dark:border-slate-600 dark:border overflow-hidden rounded-md shadow-md hover:shadow-lg dark:hover:border-1 dark:hover:border-primary transition-all duration-300 group">
          <div class="w-1/3 overflow-hidden">
            <img 
              src={bundle.data.image} 
              alt={bundle.data.title} 
              class="w-full h-full object-cover transform transition-transform duration-300 group-hover:scale-110"
            />
          </div>
          <div class="w-2/3 px-4 py-4 overflow-hidden">
            <div class="flex justify-between items-start">
              <h3 class="text-lg font-bold mb-2 group-hover:text-primary transition-colors">{bundle.data.title}</h3>
              <span class="bg-blue-100 dark:bg-primary dark:text-dark px-2 py-1 rounded font-bold text-sm whitespace-nowrap ml-2">${bundle.data.price}</span>
            </div>
            <h3 class="text-xl font-bold mb-2 group-hover:text-primary transition-colors">{bundle.data.title}</h3>
            <p class="text-muted dark:text-slate-400 mb-4">{bundle.data.description}</p>
            <div class="mb-4">
              {bundle.body.split('\n').filter(line => line.trim().startsWith('-')).map(line => (
                <div class="flex items-start mb-2">
                  <span class="text-primary dark:text-primary mr-2">â€¢</span>
                  <span class="text-sm">{line.replace('-', '').trim()}</span>
                </div>
              ))}
            </div>
            <div class="mt-2">
              <span class="text-xs font-heading text-gray-400 dark:text-gray-400 uppercase tracking-wide">Bundles</span>
            </div>
          </div>
        </a>
      ))}
    </div>
  ) : (
    <div class="w-full text-center py-12">
      <p class="text-xl text-muted dark:text-slate-400">No current bundles but more are coming, check back soon!</p>
    </div>
  )}
</WidgetWrapper>
