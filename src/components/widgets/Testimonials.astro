---
import Headline from '~/components/ui/Headline.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Button from '~/components/ui/Button.astro';
import Image from '~/components/common/Image.astro';
import type { Testimonials as Props } from '~/types';

const {
  title = '',
  subtitle = '',
  tagline = '',
  testimonials = [],
  callToAction,

  id,
  isDark = false,
  classes = {},
  wrapperClass = '',
  bg = await Astro.slots.render('bg'),
} = Astro.props;
---

<style>
  /* ✨ Fade + lift */
  .testimonial-animate {
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 0.6s ease, transform 0.6s ease;
  }
  .testimonial-animate.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* ✨ Shimmer effect */
  .shimmer {
    position: relative;
    overflow: hidden;
  }
  .shimmer::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      120deg,
      transparent 0%,
      rgba(203, 211, 235, 0.55) 50%, 
      transparent 100%
    );
    transform: translateX(-100%);
  }
  .shimmer.animate::after {
    animation: shimmer-slide 1.4s ease-out forwards;
  }

  @keyframes shimmer-slide {
    from {
      transform: translateX(-100%);
    }
    to {
      transform: translateX(200%);
    }
  }
</style>

<WidgetWrapper
  id={id}
  isDark={isDark}
  wrapperClass={wrapperClass}
  containerClass={`max-w-6xl mx-auto ${classes?.container ?? ''}`}
  bg={bg}
>
  <Headline title={title} subtitle={subtitle} tagline={tagline} />

  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
    {
      testimonials &&
        testimonials.map(({ title, testimonial, name, job, image }) => (
          <div class="flex h-auto testimonial-card testimonial-animate shimmer">   <!-- ✨ added classes -->
            <div class="flex flex-col p-4 md:p-6 rounded-md shadow-xl dark:shadow-none dark:border dark:border-slate-600">
              {title && <h2 class="text-lg font-medium leading-6 pb-4">{title}</h2>}
              {testimonial && (
                <blockquote class="flex-auto">
                  <p class="text-muted">" {testimonial} "</p>
                </blockquote>
              )}

              <hr class="border-slate-200 dark:border-slate-600 my-4" />

              <div class="flex items-center">
                {image && (
                  <div class="h-10 w-10 rounded-full">
                    {typeof image === 'string' ? (
                      <Fragment set:html={image} />
                    ) : (
                      <Image
                        class="h-10 w-10 rounded-full min-w-full min-h-full"
                        width={40}
                        height={40}
                        widths={[400, 768]}
                        layout="fixed"
                        {...image}
                      />
                    )}
                  </div>
                )}

                <div class="grow ml-3 rtl:ml-0 rtl:mr-3">
                  {name && <p class="text-base font-semibold">{name}</p>}
                  {job && <p class="text-xs text-muted">{job}</p>}
                </div>
              </div>
            </div>
          </div>
        ))
    }
  </div>

  {
    callToAction && (
      <div class="flex justify-center mx-auto w-fit mt-8 md:mt-12 font-medium">
        <Button {...callToAction} />
      </div>
    )
  }
</WidgetWrapper>

<!-- ✨ IntersectionObserver -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const items = document.querySelectorAll(".testimonial-card");

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            items.forEach((item, index) => {
              setTimeout(() => {
                item.classList.add("visible");
                item.classList.add("animate");
              }, index * 180);
            });
            observer.disconnect();
          }
        });
      },
      { threshold: 0.2 }
    );

    if (items.length) observer.observe(items[0]);
  });
</script>
<script>
  function initTestimonialsAnimation() {
    const items = document.querySelectorAll(".testimonial-card");

    if (!items.length) return;

    // Reset classes so animation can run again on nav back
    items.forEach((item) => {
      item.classList.remove("visible", "animate");
    });

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            items.forEach((item, index) => {
              setTimeout(() => {
                item.classList.add("visible");
                item.classList.add("animate");
              }, index * 180);
            });
            observer.disconnect();
          }
        });
      },
      { threshold: 0.2 }
    );

    observer.observe(items[0]);
  }

  // Initial load
  initTestimonialsAnimation();

  // Astro View Transitions (runs on every navigation)
  document.addEventListener("astro:page-load", () => {
    initTestimonialsAnimation();
  });
</script>

