---
import { getCollection } from 'astro:content';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import Headline from '~/components/ui/Headline.astro';

const {
  title,
  subtitle,
  tagline,
  id,
  isDark = false,
  classes = {},
  expirationDate,
  items,
  bg = await Astro.slots.render('bg'),
} = Astro.props;

// Use passed items or fetch from collection with default empty array
let activeFreebies = items || [];
if (!items) {
  const freebies = await getCollection('freebie');
  const currentDate = new Date();
  activeFreebies = freebies.filter((freebie) => {
    if (!freebie.data.expirationDate) return true;
    const [month, day, year] = freebie.data.expirationDate.split('/');
    const expirationDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    return currentDate <= expirationDate;
  });
  // Note: We're not sorting here anymore as it's handled in getShopComponents
}

---
<WidgetWrapper id={id} isDark={isDark} containerClass={classes?.container} bg={bg}>
  <Headline 
    title={title} 
    subtitle={subtitle} 
    tagline={tagline} 
    classes={{
      container: 'sm:mx-0 lg:max-w-none text-left md:mb-8',
      title: 'text-left',
      subtitle: 'text-left'
    }}
  />
  {activeFreebies.length > 0 ? (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 w-full">
      {activeFreebies.map((freebie, idx) => (
        <a 
          href={`/freebies/${freebie.id.replace(/\.md$/, '')}`} 
          class="relative flex flex-row md:flex-col w-full h-full dark:border-slate-600 dark:border overflow-hidden rounded-md shadow-md hover:shadow-lg dark:hover:border-1 dark:hover:border-primary transition-all duration-300 group"
          key={`freebie-${idx}`}
        >
          <div class="w-1/3 md:w-full h-full min-h-[12rem] md:h-56 overflow-hidden">
            <img 
              src={freebie.data.image}
              alt={freebie.data.title}
              class="w-full h-full object-cover md:object-cover transform transition-transform duration-300 group-hover:scale-110"
            />
          </div>
          <div class="w-2/3 md:w-full p-4 flex flex-col h-full">
            <div class="flex justify-between items-start">
              <h3 class="text-lg font-bold mb-2 group-hover:text-primary transition-colors">{freebie.data.title}</h3>
            </div>
            <p class="text-muted dark:text-slate-400 flex-grow">{freebie.data.description}</p>
            {freebie.body && (
              <div class="mt-auto pt-4">
                {freebie.body.split('\n').filter(line => line.trim().startsWith('-')).slice(0, 3).map((line, i) => (
                  <div class="flex items-start mb-1" key={`feature-${idx}-${i}`}>
                    <span class="text-primary dark:text-primary mr-2">â€¢</span>
                    <span class="text-sm">{line.replace('-', '').trim()}</span>
                  </div>
                ))}
              </div>
            )}
            <div class="mt-auto pt-2 flex justify-between items-center">
              <span class="text-xs font-heading text-gray-400 dark:text-gray-400 uppercase tracking-wide">Freebie</span>
              <span class="text-sm font-bold text-dark bg-[#649196] px-2 py-1 rounded whitespace-nowrap ml-2">Free</span>
            </div>
          </div>
        </a>
      ))}
    </div>
  ) : (
    <div class="w-full text-center py-12">
      <p class="text-xl text-muted dark:text-slate-400">No current freebies but more are coming, check back soon!</p>
    </div>
  )}
</WidgetWrapper>
