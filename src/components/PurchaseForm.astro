---
interface Props {
  title: string;
  payPalButtonId: string;
  formName: string;
  itemType: string; // "Ritual Title", "Bundle Title", or "Workshop Title"
  showAllergies?: boolean;
}

const { title, payPalButtonId, formName, itemType, showAllergies = false } = Astro.props;
---

<!-- Purchase Form -->
<div class="text-center mt-2" id="purchase">
  <div class="bg-primary/10 p-8 rounded-lg mt-6">
    <form
      name={formName}
      method="POST"
      data-netlify="true"
      netlify-honeypot="bot-field"
      class="needs-validation form-component"
      accept-charset="UTF-8"
      action="/"
    >
      <input type="hidden" name="form-name" value={formName} />
      <input type="hidden" name="product_title" value={title} />
      <input type="hidden" name="product_type" value={itemType} />
      <p class="hidden">
        <label>
          Don't fill this out if you're human: <input name="bot-field" />
        </label>
      </p>
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div>
          <label for="name" class="block text-sm font-medium mb-2 text-left md:text-center">
            Full Name <span class="text-primary">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            required
            minlength="2"
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
            placeholder="Your name"
          />
        </div>
        <div>
          <label for="email" class="block text-sm font-medium mb-2 text-left md:text-center">
            Email Address <span class="text-primary">*</span>
          </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
            placeholder="you@email.com"
          />
        </div>
        {
          showAllergies && (
            <div>
              <label for="allergies" class="block text-sm font-medium mb-2 text-left md:text-center">
                Allergies I should be aware of for the tea that will be served?
              </label>
              <input
                type="text"
                id="allergies"
                name="allergies"
                class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
                placeholder="Any allergies?"
              />
            </div>
          )
        }
      </div>
      <div class="mt-6 grid">
        <button
          type="submit"
          id="submit-btn"
          class="inline-flex items-center justify-center px-8 py-4 bg-primary dark:text-dark font-semibold rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <div id="spinner" class="hidden w-5 h-5 mr-2">
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </div>
          <span id="submit-text">Proceed to Payment</span>
        </button>
      </div>
    </form>
  </div>
  <p class="text-sm text-gray-300 text-center w-3/4 mx-auto mt-8">
    You will be redirected to PayPal checkout after submitting your information.
  </p>
</div>

<!-- Success Overlay -->
<div id="success-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md mx-4 text-center shadow-xl">
    <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
      <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Form Submitted Successfully!</h3>
    <p class="text-gray-600 dark:text-gray-400 mb-6">You will be redirected to PayPal checkout shortly...</p>
    <div class="flex items-center justify-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>
</div>

<script define:vars={{ payPalButtonId, formName, title, itemType }}>
  function initPurchaseForm() {
    const form = document.querySelector('form.form-component');
    if (!form) return;

    const submitBtn = document.getElementById('submit-btn');
    const spinner = document.getElementById('spinner');
    const submitText = document.getElementById('submit-text');
    const successOverlay = document.getElementById('success-overlay');

    const messageContainer = document.createElement('div');
    messageContainer.className = 'mt-4 hidden text-center';
    messageContainer.innerHTML = `
      <p class="text-red-600 dark:text-red-400 hidden" data-error-message>
        There was an error submitting the form. Please try again.
      </p>
    `;
    form.appendChild(messageContainer);
    const errorMessage = messageContainer.querySelector('[data-error-message]');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formEl = e.currentTarget;
      messageContainer.classList.add('hidden');

      if (submitBtn) submitBtn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (submitText) submitText.textContent = 'Submitting...';

      try {
        const formData = new FormData(formEl);

        // Explicitly set product title and type to ensure they are captured
        formData.set('product_title', title);
        formData.set('product_type', itemType);

        // Ensure Netlify form-name matches the form's name attribute
        formData.set('form-name', formEl.getAttribute('name') || formName);

        // Make sure honeypot is empty
        if (!formData.get('bot-field')) {
          formData.set('bot-field', '');
        }

        // Submit to Netlify Forms using standard AJAX pattern
        const response = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams(formData).toString(),
        });

        if (!response.ok) {
          throw new Error(`Form submission failed: ${response.status} ${response.statusText}`);
        }

        if (successOverlay) {
          successOverlay.classList.remove('hidden');
          successOverlay.classList.add('flex');
        }

        setTimeout(() => {
          const paypalUrl = `https://www.paypal.com/ncp/payment/${payPalButtonId}`;
          window.location.assign(paypalUrl);
        }, 1200);

        formEl.reset();
      } catch (err) {
        console.error('Error submitting form to Netlify:', err);
        if (submitBtn) submitBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (submitText) submitText.textContent = 'Proceed to Payment';
        messageContainer.classList.remove('hidden');
        if (errorMessage) errorMessage.classList.remove('hidden');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPurchaseForm);
  } else {
    initPurchaseForm();
  }
</script>
