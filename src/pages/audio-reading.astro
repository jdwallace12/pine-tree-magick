---
import Layout from '~/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

const metadata = {
  title: 'Audio Readings | Pine Tree Magick',
  description: 'Book an audio reading with Jersey - personalized astrological insights and guided rituals',
};

// PayPal Button ID for audio readings
const payPalButtonId = 'N5SATHTNU4MAQ'; // Replace with actual PayPal button ID
---

<style>
  /* Custom checkbox styles */
  .custom-checkbox {
    @apply relative flex items-start;
  }

  .custom-checkbox input[type="checkbox"] {
    @apply absolute opacity-0 w-5 h-5 cursor-pointer;
  }

  .custom-checkbox .checkbox-label {
    @apply pl-7 relative select-none;
  }

  .custom-checkbox .checkbox-label::before {
    content: '';
    @apply absolute left-0 top-1 w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded transition-all duration-200;
  }

  .custom-checkbox input[type="checkbox"]:checked + .checkbox-label::before {
    @apply bg-primary border-primary;
  }

  .custom-checkbox .checkbox-label::after {
    content: '';
    @apply absolute left-[6px] top-[9px] w-2.5 h-1.5 border-gray-900 dark:border-gray-900 border-l-2 border-b-2 transform -rotate-45 opacity-0 transition-all duration-200;
  }

  .custom-checkbox input[type="checkbox"]:checked + .checkbox-label::after {
    @apply opacity-100;
  }

  .custom-checkbox input[type="checkbox"]:focus + .checkbox-label::before {
    @apply ring-2 ring-opacity-50 ring-primary;
  }

  /* Custom radio button styles */
  .custom-radio {
    @apply relative flex items-start;
  }

  .custom-radio input[type="radio"] {
    @apply absolute opacity-0 w-5 h-5 cursor-pointer;
  }

  .custom-radio .radio-label {
    @apply pl-7 relative select-none;
  }

  .custom-radio .radio-label::before {
    content: '';
    @apply absolute left-0 top-1 w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded-full transition-all duration-200;
  }

  .custom-radio input[type="radio"]:checked + .radio-label::before {
    @apply bg-primary border-primary;
  }

  .custom-radio .radio-label::after {
    content: '';
    @apply absolute left-[6px] top-[9px] w-2 h-2 bg-white dark:bg-gray-900 rounded-full opacity-0 transition-all duration-200;
  }

  .custom-radio input[type="radio"]:checked + .radio-label::after {
    @apply opacity-100;
  }

  .custom-radio input[type="radio"]:focus + .radio-label::before {
    @apply ring-2 ring-opacity-50 ring-primary;
  }

  /* Radio button container styling */
  .radio-option {
    @apply p-4 border border-gray-200 dark:border-gray-600 rounded-lg cursor-pointer transition-all duration-200;
  }

  .radio-option:hover {
    @apply bg-gray-50 dark:bg-gray-800/50 border-primary;
  }

  .radio-option:has(input[type="radio"]:checked) {
    @apply bg-pink-50 dark:bg-pink-900/20 border-primary ring-1 ring-primary;
  }
</style>

<Layout metadata={metadata}>
  <Fragment slot="announcement"></Fragment>
  
  <div class="mx-auto max-w-4xl p-4 md:px-8">
    <div class="text-center mb-12">
      <p class="text-base text-secondary dark:text-secondary font-bold tracking-wide uppercase mt-12">Book Your Audio Reading</p>
      <h1 class="font-normal tracking-tighter font-heading text-heading text-4xl md:text-5xl mb-4">
        Audio Readings + Guided Rituals
      </h1>
      <p class="text-xl mb-6 text-muted">$125</p>
      <p>Audio readings are pre-recorded and include astrological insight and a Tarot card message from Spirit. Along with this detailed audio reading, you'll receive a guided ritual to help you work your desired manifestation. Each written ritual includes a link to a recorded meditation, journal prompts, altar suggestions, timing recommendations, and a step-by-step guide to help you manifest your intention.</p>

    <!-- Booking Form -->
    <div class="bg-primary/10 p-8 rounded-lg mt-12">
      <form 
        name="audio-reading"
        method="POST"
        data-netlify="true"
        netlify-honeypot="bot-field"
        class="needs-validation form-component"
        action="/success"
      >
        <input type="hidden" name="form-name" value="audio-reading" />
        <p class="hidden">
          <label>
            Don't fill this out if you're human: <input name="bot-field" />
          </label>
        </p>
        <!-- Personal Information -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div>
            <label for="name" class="block text-sm font-medium mb-2 text-left md:text-center">
              Full Name <span class="text-primary">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              minlength="2"
              class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
              placeholder="Your name"
            />
          </div>
          
          <div>
            <label for="email" class="block text-sm font-medium mb-2 text-left md:text-center">
              Email Address <span class="text-primary">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
              placeholder="your@email.com"
            />
          </div>
        </div>

        <!-- Birth Information -->
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div>
            <label for="birthday" class="block text-sm font-medium mb-2 text-left md:text-center">
              Birthday <span class="text-primary">*</span>
            </label>
            <input
              type="date"
              id="birthday"
              name="birthday"
              required
              class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
            />
          </div>
          
          <div>
            <label for="birthTime" class="block text-sm font-medium mb-2 text-left md:text-center">
              Birth Time <span class="text-primary">*</span>
            </label>
            <input
              type="time"
              id="birthTime"
              name="birthTime"
              required
              class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
            />
          </div>
          
          <div>
            <label for="birthPlace" class="block text-sm font-medium mb-2 text-left md:text-center">
              Birth Place <span class="text-primary">*</span>
            </label>
            <input
              type="text"
              id="birthPlace"
              name="birthPlace"
              required
              minlength="2"
              class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
              placeholder="City, State/Country"
            />
          </div>
        </div>

        <!-- Reading Type Selection -->
        <div class="mb-6 py-8">
          <label class="block text-sm font-medium mb-4 text-left md:text-center">
            Select Your Audio Reading Type <span class="text-primary">*</span>
          </label>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="radio-option">
              <div class="custom-radio">
                <input
                  type="radio"
                  name="readingType"
                  value="career-money"
                  required
                />
                <span class="radio-label">
                  <div class="font-medium">Career and Money Reading</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">+ Money Ritual</div>
                </span>
              </div>
            </label>
            
            <label class="radio-option">
              <div class="custom-radio">
                <input
                  type="radio"
                  name="readingType"
                  value="love"
                  required
                />
                <span class="radio-label">
                  <div class="font-medium">Love Reading</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">+ Love Spell</div>
                </span>
              </div>
            </label>
            
            <label class="radio-option">
              <div class="custom-radio">
                <input
                  type="radio"
                  name="readingType"
                  value="soul-purpose"
                  required
                />
                <span class="radio-label">
                  <div class="font-medium">Soul Purpose Reading</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">+ Highest Self Ritual</div>
                </span>
              </div>
            </label>
            
            <label class="radio-option">
              <div class="custom-radio">
                <input
                  type="radio"
                  name="readingType"
                  value="radiant-gifts"
                  required
                />
                <span class="radio-label">
                  <div class="font-medium">Radiant Gifts Reading</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">+ Self-Love Ritual</div>
                </span>
              </div>
            </label>
          </div>
        </div>

        <!-- Additional Notes -->
        <div class="mb-6">
          <label for="notes" class="block text-sm font-medium mb-2 text-left md:text-center">
            Additional Notes (Optional)
          </label>
          <textarea
            id="notes"
            name="notes"
            rows="4"
            class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
            placeholder="Any specific questions or areas you'd like Jersey to focus on during your reading..."
          ></textarea>
        </div>

        <!-- Disclaimer -->
        <div class="mb-6">
          <label class="custom-checkbox text-left md:text-center">
            <input
              type="checkbox"
              name="disclaimer"
              required
            />
            <span class="checkbox-label">
              I agree to the terms in the 
              <a
                target="_blank" 
                href="/disclaimer" 
                class="text-primary hover:underline"
              >
                disclaimer
              </a>
            </span>
          </label>
        </div>

        <!-- Submit Button -->
        <div class="mt-10 grid">
          <button
            type="submit"
            id="submit-btn"
            class="inline-flex items-center justify-center px-8 py-4 bg-primary dark:text-dark font-semibold rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <div id="spinner" class="hidden w-5 h-5 mr-2">
              <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </div>
            <Icon name="tabler:credit-card" id="submit-icon" class="w-5 h-5 mr-2" />
            <span id="submit-text">Proceed to Payment - $125</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Hidden PayPal Form -->
  <form
    id="paypal-form"
    action={`https://www.paypal.com/ncp/payment/${payPalButtonId}`}
    method="post"
    target="_top"
    style="display: none;"
  >
    <input type="hidden" id="paypal-name" name="name" />
    <input type="hidden" id="paypal-email" name="email" />
    <input type="hidden" id="paypal-birthday" name="birthday" />
    <input type="hidden" id="paypal-birthTime" name="birthTime" />
    <input type="hidden" id="paypal-birthPlace" name="birthPlace" />
    <input type="hidden" id="paypal-readingType" name="readingType" />
    <input type="hidden" id="paypal-notes" name="notes" />
  </form>

  <!-- Success Overlay -->
  <div id="success-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md mx-4 text-center shadow-xl">
      <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
        <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Form Submitted Successfully!</h3>
      <p class="text-gray-600 dark:text-gray-400 mb-6">You will be redirected to PayPal checkout shortly...</p>
      <div class="flex items-center justify-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
        <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
        <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
        <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('.form-component') as HTMLFormElement;
      if (!form) return;
      
      // Get form elements
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const spinner = document.getElementById('spinner') as HTMLElement;
      const submitIcon = document.getElementById('submit-icon') as HTMLElement;
      const submitText = document.getElementById('submit-text') as HTMLElement;
      const successOverlay = document.getElementById('success-overlay') as HTMLElement;
      
      const messageContainer = document.createElement('div');
      messageContainer.className = 'mt-4 hidden text-center';
      messageContainer.innerHTML = `
        <p class="text-red-600 dark:text-red-400 hidden" data-error-message>
          There was an error submitting the form. Please try again.
        </p>
      `;
      form.appendChild(messageContainer);
      
      const errorMessage = messageContainer.querySelector('[data-error-message]') as HTMLElement;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageContainer.classList.add('hidden');
        
        // Show spinner and disable button
        if (submitBtn) {
          submitBtn.disabled = true;
        }
        if (spinner) {
          spinner.classList.remove('hidden');
        }
        if (submitIcon) {
          submitIcon.classList.add('hidden');
        }
        if (submitText) {
          submitText.textContent = 'Submitting...';
        }
        
        try {
          const formData = new FormData(e.target as HTMLFormElement);
          
          // Submit to Netlify Forms
          const response = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(formData as any).toString()
          });

          if (response.ok) {
            // Show success overlay
            if (successOverlay) {
              successOverlay.classList.remove('hidden');
              successOverlay.classList.add('flex');
            }
            
            // Redirect to PayPal after successful form submission
            setTimeout(() => {
              // Get form data for PayPal
              const name = formData.get('name');
              const email = formData.get('email');
              const birthday = formData.get('birthday');
              const birthTime = formData.get('birthTime');
              const birthPlace = formData.get('birthPlace');
              const readingType = formData.get('readingType');
              const notes = formData.get('notes');
              
              // Set PayPal form data
              const paypalName = document.getElementById('paypal-name') as HTMLInputElement;
              const paypalEmail = document.getElementById('paypal-email') as HTMLInputElement;
              const paypalBirthday = document.getElementById('paypal-birthday') as HTMLInputElement;
              const paypalBirthTime = document.getElementById('paypal-birthTime') as HTMLInputElement;
              const paypalBirthPlace = document.getElementById('paypal-birthPlace') as HTMLInputElement;
              const paypalReadingType = document.getElementById('paypal-readingType') as HTMLInputElement;
              const paypalNotes = document.getElementById('paypal-notes') as HTMLInputElement;
              const paypalForm = document.getElementById('paypal-form') as HTMLFormElement;
              
              if (paypalName) paypalName.value = name as string;
              if (paypalEmail) paypalEmail.value = email as string;
              if (paypalBirthday) paypalBirthday.value = birthday as string;
              if (paypalBirthTime) paypalBirthTime.value = birthTime as string;
              if (paypalBirthPlace) paypalBirthPlace.value = birthPlace as string;
              if (paypalReadingType) paypalReadingType.value = readingType as string;
              if (paypalNotes) paypalNotes.value = notes as string || '';
              
              // Submit PayPal form
              if (paypalForm) paypalForm.submit();
            }, 1500);
            
            form.reset();
          } else {
            throw new Error('Form submission failed');
          }
        } catch (error) {
          console.error('Error submitting form:', error);
          
          // Reset button state
          if (submitBtn) {
            submitBtn.disabled = false;
          }
          if (spinner) {
            spinner.classList.add('hidden');
          }
          if (submitIcon) {
            submitIcon.classList.remove('hidden');
          }
          if (submitText) {
            submitText.textContent = 'Proceed to Payment - $125';
          }
          
          // Show error message
          messageContainer.classList.remove('hidden');
          if (errorMessage) errorMessage.classList.remove('hidden');
        }
      });
    });
  </script>
</Layout>
