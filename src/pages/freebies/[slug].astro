---
import { getCollection } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

export async function getStaticPaths() {
  const freebies = await getCollection('freebie');
  return freebies.map((freebie) => ({
    params: { slug: freebie.id.replace(/\.md$/, '') },
  }));
}

const { slug } = Astro.params as { slug: string };
const freebies = await getCollection('freebie');

const freebie = freebies.find((freebie) => (freebie.id.replace(/\.md$/, '')) === slug);

if (!freebie) {
  throw new Error('freebie not found');
}

const { title, description, image, expirationDate, pdfUrl } = freebie.data;
const { Content } = await freebie.render();

// Convert Google Drive URL to preview URL
const getPreviewUrl = (url: string) => {
  if (url.includes('drive.google.com')) {
    // Extract file ID
    const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (fileIdMatch && fileIdMatch[1]) {
      const fileId = fileIdMatch[1];
      // Return the preview URL format
      return `https://drive.google.com/file/d/${fileId}/preview`;
    }
  }
  return url;
};

const previewUrl = getPreviewUrl(pdfUrl);

const metadata = {
  title,
  description,
  openGraph: {
    url: image,
    siteName: title,
    images: [{
      url: image,
      width: 1200,
      height: 630
    }],
    type: "website"
  }
};

const isExpired = expirationDate ? new Date() > new Date(expirationDate) : false;
---

<Layout metadata={metadata}>
  <article class="max-w-2xl mx-auto p-6 space-y-6 mb-12">
    <div class="flex items-center justify-between bg-dark py-4 sticky top-[4.5rem]">
      <a href="/shop" class="flex underline w-max">
        <Icon name="tabler:arrow-left" class="w-5 h-5 mr-1" />Back to Shop
      </a>
      <a class="btn-primary ml-2 py-2.5 px-5.5 md:px-6 font-semibold shadow-none text-sm w-auto" href="#download">Download</a>
    </div>
    
    <div class="flex flex-col gap-8">
      <div>
        <p class="text-base text-secondary dark:text-secondary font-bold tracking-wide uppercase text-center mt-12">
          Freebies
        </p>
        <h1 class="text-4xl md:text-5xl font-heading text-center">{title}</h1>
        <p class="text-xl text-muted text-center mt-2">{description}</p>
      </div>
   
      <img src={image} alt={title} class="w-full h-64 object-cover rounded-lg shadow-md" />
    
      <div class="mb-2 prose prose-lg prose-headings:text-primary prose-headings:font-heading prose-p:text-muted prose-li:text-muted prose-strong:text-heading prose-strong:font-semibold dark:prose-invert max-w-none">
        <Content />
        {isExpired ? (
          <div class="bg-red-900/50 text-red-200 p-4 rounded-lg text-center mb-6">
            This freebie has expired and is no longer available.
          </div>
        ) : (
          <div class="text-center mt-2" id="download">
            <div class="bg-primary/10 p-8 rounded-lg mt-6">
              <form 
                name="freebie-download"
                method="POST"
                data-netlify="true"
                netlify-honeypot="bot-field"
                data-netlify-recaptcha="false"
                class="needs-validation form-component"
                accept-charset="UTF-8"
                action="/"
              >
                <input type="hidden" name="form-name" value="freebie-download" />
                <input type="hidden" name="freebie" value={title} />
                <p class="hidden">
                  <label>
                    Don't fill this out if you're human: <input name="bot-field" />
                  </label>
                </p>
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                  <div>
                    <label for="name" class="block text-sm font-medium mb-2 text-left md:text-center">
                      Full Name <span class="text-primary">*</span>
                    </label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      required
                      minlength="2"
                      class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
                      placeholder="Your name"
                    />
                  </div>
                  <div>
                    <label for="email" class="block text-sm font-medium mb-2 text-left md:text-center">
                      Email Address <span class="text-primary">*</span>
                    </label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      required
                      class="py-3 px-4 block w-full text-md rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-dark"
                      placeholder="you@email.com"
                    />
                  </div>
                </div>
                <div class="mt-6 grid">
                  <button
                    type="submit"
                    id="submit-btn"
                    class="inline-flex items-center justify-center px-8 py-4 bg-primary dark:text-dark font-semibold rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div id="spinner" class="hidden w-5 h-5 mr-2">
                      <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                    <span id="submit-text">Get Free Download</span>
                  </button>
                </div>
              </form>
            </div>
            <p class="text-sm text-gray-300 text-center w-3/4 mx-auto mt-8">You'll be redirected to your PDF after submitting.</p>
          </div>
        )}
      </div>
    </div>
  </article>
</Layout>

<!-- Success Overlay -->
<div id="success-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-8 max-w-md mx-4 text-center shadow-xl">
    <div class="w-16 h-16 mx-auto mb-4 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
      <svg class="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2">Form Submitted Successfully!</h3>
    <p class="text-gray-600 dark:text-gray-400 mb-6">Opening your PDF...</p>
    <div class="flex items-center justify-center space-x-2 text-sm text-gray-500 dark:text-gray-400">
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div>
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-2 h-2 bg-primary rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>
</div>

<script define:vars={{ previewUrl }}>
  function initFreebieForm() {
    const form = document.querySelector('form.form-component');
    if (!form) return;

    const submitBtn = document.getElementById('submit-btn');
    const spinner = document.getElementById('spinner');
    const submitText = document.getElementById('submit-text');
    const successOverlay = document.getElementById('success-overlay');

    const messageContainer = document.createElement('div');
    messageContainer.className = 'mt-4 hidden text-center';
    messageContainer.innerHTML = `
      <p class="text-red-600 dark:text-red-400 hidden" data-error-message>
        There was an error submitting the form. Please try again.
      </p>
    `;
    form.appendChild(messageContainer);
    const errorMessage = messageContainer.querySelector('[data-error-message]');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageContainer.classList.add('hidden');

      if (submitBtn) submitBtn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (submitText) submitText.textContent = 'Submitting...';

      try {
        const formEl = e.currentTarget || form;
        const formData = new FormData(formEl);
        const formNameAttr = formEl.getAttribute('name') || 'freebie-download';
        formData.set('form-name', String(formNameAttr));
        if (!formData.get('bot-field')) formData.set('bot-field', '');

        // Ensure explicit fields
        const getVal = (id) => {
          const el = document.getElementById(id);
          const raw = (el && 'value' in el ? el.value : formData.get(id));
          return raw == null ? '' : String(raw);
        };
        formData.set('name', String(getVal('name')));
        formData.set('email', String(getVal('email')));

        const params = new URLSearchParams();
        params.append('form-name', String(formData.get('form-name') || 'freebie-download'));
        params.append('bot-field', String(formData.get('bot-field') || ''));
        for (const [key, value] of formData.entries()) {
          if (key === 'form-name' || key === 'bot-field') continue;
          params.append(key, String(value));
        }

        // Submit to root path for Netlify forms (more reliable than page path)
        const response = await fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: params.toString()
        });

        if (!response.ok) {
          throw new Error(`Form submission failed: ${response.status} ${response.statusText}`);
        }

        if (successOverlay) {
          successOverlay.classList.remove('hidden');
          successOverlay.classList.add('flex');
        }

        setTimeout(() => {
          window.location.href = previewUrl;
        }, 1200);

        if (typeof formEl.reset === 'function') {
          formEl.reset();
        }
      } catch (err) {
        console.error('Error submitting form to Netlify:', err);
        if (submitBtn) submitBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (submitText) submitText.textContent = 'Get Free Download';
        messageContainer.classList.remove('hidden');
        if (errorMessage) errorMessage.classList.remove('hidden');
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFreebieForm);
  } else {
    initFreebieForm();
  }
</script>
